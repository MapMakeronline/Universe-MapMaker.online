# Universe-MapMaker Backend-Frontend API Compatibility Report

**Data:** 2025-01-13
**Analiza:** Backend (Django/QGIS) vs Frontend (Next.js/RTK Query)
**Status:** 45% pokrycie endpoint√≥w, 1 krytyczny bug, 15 niezgodno≈õci parametr√≥w

---

## üö® KRYTYCZNE B≈ÅƒòDY DO NATYCHMIASTOWEGO NAPRAWIENIA

### Bug #1: Brak prefiksu `/projects/` w parametrze MAP (BACKEND)

**Lokalizacja:** `Universe-Mapmaker-Backend/geocraft_api/projects/service.py:4591`

**Problem:**
```python
# ‚ùå B≈ÅƒÑD (linia 4591):
url = (
    f"{qgis_server_url}?"
    f"SERVICE=WMS&"
    f"VERSION=1.3.0&"
    f"REQUEST=GetCapabilities&"
    f"MAP={project_name}/{project_name}.qgs"  # Brak /projects/!
)
```

**Powinno byƒá:**
```python
# ‚úÖ POPRAWNIE:
MAP=/projects/{project_name}/{project_name}.qgs
```

**Wp≈Çyw:**
- üî¥ **WYSOKI** - Walidacja QGIS Server zawsze zawodzi
- Publikacja projekt√≥w mo≈ºe siƒô nie udaƒá
- Licznik warstw zwraca 0

**Dow√≥d:**
- Frontend u≈ºywa `/projects/` (qgis-layers.ts:148, 256 i QGISProjectLoader.tsx:198) ‚úÖ
- Inne funkcje backendu u≈ºywajƒÖ `/projects/` (service.py:3824) ‚úÖ
- Tylko `validate_qgis_server_access()` NIE u≈ºywa prefiksu ‚ùå

---

## üìä STATYSTYKI POKRYCIA API

| Kategoria | Liczba | Procent |
|-----------|--------|---------|
| **Wszystkie endpointy backendu** | 97 | 100% |
| **Zaimplementowane w frontendzie** | 44 | 45% |
| **BrakujƒÖce w frontendzie** | 53 | 55% |
| **Niezgodno≈õci parametr√≥w** | 15 | - |
| **Krytyczne bugi** | 1 | - |

---

## ‚úÖ POPRAWNIE ZAIMPLEMENTOWANE ENDPOINTY

### Projects API (18/52 endpoint√≥w)

| Endpoint | Hook | Status |
|----------|------|--------|
| POST /api/projects/create/ | useCreateProjectMutation | ‚úÖ OK |
| POST /api/projects/import/qgs/ | useImportQGSMutation | ‚úÖ OK |
| POST /api/projects/import/qgz/ | useImportQGZMutation | ‚úÖ OK |
| POST /api/projects/remove/ | useDeleteProjectMutation | ‚úÖ OK |
| POST /api/projects/export | useExportProjectMutation | ‚úÖ OK |
| POST /api/projects/publish | useTogglePublishMutation | ‚úÖ OK |
| POST /api/projects/logo/update/ | useUpdateLogoMutation | ‚úÖ OK |
| POST /api/projects/metadata | useSetMetadataMutation | ‚úÖ OK |
| GET /api/projects/new/json | useGetProjectDataQuery | ‚úÖ OK |
| POST /api/projects/tree/order | useChangeLayersOrderMutation | ‚úÖ OK |
| POST /api/projects/reload | useReloadProjectMutation | ‚úÖ OK |
| POST /api/projects/repair | useRepairProjectMutation | ‚úÖ OK |
| POST /api/projects/restore | useRestoreProjectMutation | ‚úÖ OK |
| POST /api/projects/basemap/set | useSetBasemapMutation | ‚úÖ OK |
| POST /api/projects/print | usePreparePrintImageMutation | ‚úÖ OK |

### Layers API (26/65 endpoint√≥w)

| Endpoint | Hook | Status |
|----------|------|--------|
| POST /api/layer/add/geojson/ | useAddGeoJsonLayerMutation | ‚úÖ OK |
| POST /api/layer/add/shp/ | useAddShapefileLayerMutation | ‚úÖ OK |
| POST /api/layer/add/gml/ | useAddGMLLayerMutation | ‚úÖ OK |
| POST /api/layer/style | useUpdateLayerStyleMutation | ‚úÖ OK |
| POST /api/layer/style/reset | useResetLayerStyleMutation | ‚úÖ OK |
| POST /api/layer/remove/database | useDeleteLayerMutation | ‚úÖ OK |
| POST /api/layer/selection | useSetLayerVisibilityMutation | ‚úÖ OK |
| POST /api/layer/attributes | useGetLayerAttributesQuery | ‚úÖ OK |
| POST /api/layer/features | useGetFeaturesQuery | ‚úÖ OK |
| POST /api/layer/geometry | useGetGeometryQuery | ‚úÖ OK |
| POST /api/layer/label | useAddLabelMutation | ‚úÖ OK |
| POST /api/layer/clone | useCloneLayerMutation | ‚úÖ OK |
| GET /layer/export | useExportLayerMutation | ‚úÖ OK |

---

## ‚ùå BRAKUJƒÑCE FUNKCJE (Wysoki Priorytet)

### 1. Edycja obiekt√≥w (WFS-T)

**BrakujƒÖce endpointy:**
- `POST /api/layer/feature/add` - Dodawanie nowych obiekt√≥w
- `POST /api/layer/feature/update` - Edycja geometrii/atrybut√≥w
- `POST /api/layer/feature/delete` - Usuwanie obiekt√≥w

**Wp≈Çyw:** ‚ùå Brak interaktywnej edycji obiekt√≥w na mapie

**RozwiƒÖzanie tymczasowe:**
U≈ºyƒá `POST /api/layer/transaction/` z XML WFS-T

### 2. Obs≈Çuga warstw rastrowych

**BrakujƒÖce endpointy:**
- `POST /api/layer/add/raster/` - Dodawanie TIF/raster
- `POST /api/layer/georefer` - Georeferencja obraz√≥w
- `POST /api/layer/mask` - Maskowanie rastra
- `POST /api/layer/transparency` - Przezroczysto≈õƒá rastra

**Wp≈Çyw:** ‚ùå Brak mo≈ºliwo≈õci dodawania map rastrowych

### 3. Kontrola widoczno≈õci warstw

**BrakujƒÖce endpointy:**
- `POST /api/layer/opacity/set` - Ustawienie przezroczysto≈õci
- `POST /api/layer/scale` - Widoczno≈õƒá zale≈ºna od skali
- `POST /api/layer/published/set` - Publikacja warstwy

**Wp≈Çyw:** ‚ö†Ô∏è Ograniczona kontrola wy≈õwietlania warstw

---

## üîß NIEZGODNO≈öCI PARAMETR√ìW

### Snake_case (Backend) vs camelCase (Frontend)

| Backend | Frontend | Wp≈Çyw | Status |
|---------|----------|-------|--------|
| project_name | projectName | üî¥ Wysoki | ‚ö†Ô∏è Wymaga transformacji |
| layer_name | layerName | üî¥ Wysoki | ‚ö†Ô∏è Wymaga transformacji |
| feature_id | featureId | üü° ≈öredni | ‚ö†Ô∏è Wymaga transformacji |
| column_name | columnName | üü° ≈öredni | ‚ö†Ô∏è Wymaga transformacji |
| column_type | columnType | üü° ≈öredni | ‚ö†Ô∏è Wymaga transformacji |
| old_name | oldName | üü° ≈öredni | ‚ö†Ô∏è Wymaga transformacji |
| new_name | newName | üü° ≈öredni | ‚ö†Ô∏è Wymaga transformacji |

**Przyk≈Çad poprawnej transformacji:**
```typescript
query: ({ projectName, layerName }) => ({
  url: '/api/layer/attributes',
  method: 'POST',
  body: {
    project_name: projectName,  // ‚Üê Transformacja
    layer_name: layerName,      // ‚Üê Transformacja
  }
})
```

---

## üó∫Ô∏è INTEGRACJA QGIS SERVER

### ‚úÖ Poprawnie skonfigurowane

**Backend:**
- URL wewnƒôtrzny: `http://qgis-server:8080` (Docker)
- URL publiczny: `https://api.universemapmaker.online/ows`
- ≈öcie≈ºka projekt√≥w: `QGIS_PROJECTS_PATH=/projects`

**Frontend:**
- Base URL: `https://api.universemapmaker.online/ows`
- Parametr MAP: `/projects/{projectName}/{projectName}.qgs` ‚úÖ

### WMS GetMap - Poprawnie

```typescript
// qgis-layers.ts:135-148
SERVICE=WMS
VERSION=1.3.0
REQUEST=GetMap
LAYERS=layer_name
STYLES=                    // ‚úÖ Dodane
WIDTH=256
HEIGHT=256
CRS=EPSG:3857
BBOX={bbox-epsg-3857}
FORMAT=image/png
TRANSPARENT=true
DPI=96                     // ‚úÖ Dodane
MAP=/projects/{name}/{name}.qgs  // ‚úÖ Poprawne
```

### WFS GetFeature - Poprawnie

```typescript
// qgis-layers.ts:248-256
SERVICE=WFS
VERSION=1.1.0
REQUEST=GetFeature
TYPENAME=layer_name
OUTPUTFORMAT=application/json
SRSNAME=EPSG:4326
MAXFEATURES=1000
MAP=/projects/{name}/{name}.qgs  // ‚úÖ Poprawne
```

---

## üìù ZALECENIA - FRONTEND

### Natychmiastowe (Krytyczne)

#### 1. Czekaj na poprawkƒô backendu
**NIE implementuj** nowych funkcji przed naprawƒÖ buga w `service.py:4591`

#### 2. Weryfikacja transformacji parametr√≥w
Sprawd≈∫ wszystkie mutacje w `layersApi.ts`:
```typescript
// Sprawd≈∫ ka≈ºdƒÖ mutacjƒô
useGetLayerAttributesQuery()
useSetLayerVisibilityMutation()
useGetFeaturesQuery()
// ... etc
```

### Wysokie (Nastƒôpny sprint)

#### 3. Implementacja edycji obiekt√≥w
```typescript
// Opcja 1: Je≈õli backend ma feature/add endpoint
addFeature: builder.mutation<...>({
  url: '/api/layer/feature/add',
  // ...
})

// Opcja 2: U≈ºyj WFS-T
addFeatureWFS: builder.mutation<...>({
  url: '/api/layer/transaction/',
  body: { transaction_xml: '...' }
})
```

#### 4. Dodaj kontrolƒô przezroczysto≈õci warstw
```typescript
setLayerOpacity: builder.mutation<
  { success: boolean },
  { projectName: string; layerName: string; opacity: number }
>({
  query: ({ projectName, layerName, opacity }) => ({
    url: '/api/layer/opacity/set',
    method: 'POST',
    body: {
      project_name: projectName,
      layer_name: layerName,
      opacity,
    },
  }),
})
```

#### 5. Implementacja warstw rastrowych
```typescript
addRasterLayer: builder.mutation<
  { success: boolean; layer_name: string },
  { projectName: string; layerName: string; file: File }
>({
  query: ({ projectName, layerName, file }) => {
    const formData = new FormData();
    formData.append('project', projectName);
    formData.append('layer_name', layerName);
    formData.append('file', file);

    return {
      url: '/api/layer/add/raster/',
      method: 'POST',
      body: formData,
    };
  },
})
```

### ≈örednie (Q1 2025)

- Operacje przestrzenne PostGIS
- Import/eksport styl√≥w (SLD/QML)
- ZarzƒÖdzanie dokumentami projekt√≥w
- Filtrowanie i wyszukiwanie

---

## üß™ LISTA TEST√ìW

### Backend Bug Test

```bash
# Test 1: Obecny (powinien zawie≈õƒá)
curl "http://qgis-server:8080/?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetCapabilities&MAP=MyProject/MyProject.qgs"
# Oczekiwane: 404 Not Found

# Test 2: Po poprawce (powinien dzia≈Çaƒá)
curl "http://qgis-server:8080/?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetCapabilities&MAP=/projects/MyProject/MyProject.qgs"
# Oczekiwane: 200 OK z XML
```

### Frontend Parameter Test

```typescript
// Test transformacji parametr√≥w
const { data } = useGetLayerAttributesQuery({
  projectName: "MyProject",
  layerName: "buildings"
});

// Network tab powinien pokazaƒá:
// POST /api/layer/attributes
// Body: { "project_name": "MyProject", "layer_name": "buildings" }
```

### QGIS Integration Test

```typescript
// Test ≈Çadowania WMS
const wmsUrl = "https://api.universemapmaker.online/ows?" +
  "SERVICE=WMS&VERSION=1.3.0&REQUEST=GetMap" +
  "&LAYERS=buildings&STYLES=" +
  "&WIDTH=256&HEIGHT=256&CRS=EPSG:3857" +
  "&BBOX=-10000,-10000,10000,10000" +
  "&FORMAT=image/png&TRANSPARENT=true&DPI=96" +
  "&MAP=/projects/MyProject/MyProject.qgs";

fetch(wmsUrl)
  .then(r => console.log('WMS Status:', r.status))
  .catch(e => console.error('WMS Error:', e));
```

---

## üìã ZADANIA DO WYKONANIA

### Krytyczne (Natychmiast)

- [ ] **Backend Team:** Napraw MAP parametr w `service.py:4591` (dodaj `/projects/`)
- [ ] **Frontend Team:** Zweryfikuj transformacjƒô parametr√≥w we wszystkich mutacjach
- [ ] **Dokumentacja:** Popraw `owner_id` ‚Üí `user_id` w dokumentacji

### Wysokie (Nastƒôpny sprint)

- [ ] **Backend Team:** Wyja≈õnij endpointy do edycji obiekt√≥w (feature add/update/delete)
- [ ] **Frontend Team:** Implementuj edycjƒô obiekt√≥w (WFS-T lub dedykowane endpointy)
- [ ] **Frontend Team:** Dodaj kontrolƒô przezroczysto≈õci/widoczno≈õci warstw
- [ ] **Frontend Team:** Zaimplementuj upload warstw rastrowych

### ≈örednie (Q1 2025)

- [ ] **Frontend Team:** Operacje przestrzenne PostGIS
- [ ] **Frontend Team:** Import/eksport styl√≥w
- [ ] **Frontend Team:** ZarzƒÖdzanie dokumentami
- [ ] **Frontend Team:** Filtrowanie i wyszukiwanie

### Niska (Backlog)

- [ ] **Frontend Team:** ZarzƒÖdzanie subuserami (wsp√≥≈Çpraca)
- [ ] **Frontend Team:** Integracja Wypis (je≈õli potrzebna)
- [ ] **Frontend Team:** Zaawansowane opcje publikacji

---

## üìÅ STRUKTURA PLIK√ìW PROJEKTU

### Backend (Django)
```
Universe-Mapmaker-Backend/
‚îú‚îÄ‚îÄ geocraft_api/
‚îÇ   ‚îú‚îÄ‚îÄ projects/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ urls.py          # 52 endpointy
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ views.py         # Logika endpoint√≥w
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ service.py       # üî¥ BUG: linia 4591
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ serializers.py
‚îÇ   ‚îú‚îÄ‚îÄ layers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ urls.py          # 65 endpoint√≥w
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ views.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ db_utils.py      # ‚úÖ ST_Extent naprawione
‚îÇ   ‚îî‚îÄ‚îÄ json_utils.py        # ‚úÖ Threading naprawiony
‚îú‚îÄ‚îÄ geocraft/
‚îÇ   ‚îî‚îÄ‚îÄ settings.py          # Konfiguracja QGIS
‚îî‚îÄ‚îÄ .env
    ‚îú‚îÄ‚îÄ QGIS_PROJECTS_PATH=/projects
    ‚îî‚îÄ‚îÄ QGIS_SERVER_URL=http://qgis-server:8080
```

### Frontend (Next.js)
```
Universe-MapMaker.online/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ redux/api/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ projectsApi.ts   # 18 endpoint√≥w ‚úÖ
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ layersApi.ts     # 26 endpoint√≥w ‚úÖ
‚îÇ   ‚îú‚îÄ‚îÄ mapbox/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ qgis-layers.ts   # WMS/WFS ‚úÖ
‚îÇ   ‚îú‚îÄ‚îÄ components/qgis/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ QGISProjectLoader.tsx  # ‚úÖ
‚îÇ   ‚îî‚îÄ‚îÄ features/warstwy/
‚îÇ       ‚îî‚îÄ‚îÄ komponenty/
‚îÇ           ‚îú‚îÄ‚îÄ LayerTree.tsx      # ‚úÖ Zoom fixed
‚îÇ           ‚îî‚îÄ‚îÄ LeftPanel.tsx      # ‚úÖ Header fixed
‚îî‚îÄ‚îÄ BACKEND-FRONTEND-API-COMPATIBILITY-REPORT.md  # Ten raport
```

---

## üîê AUTENTYKACJA I CORS

### Backend Authentication
```python
# Token-based auth (Django REST Framework)
Authorization: Token <token_value>

# Chronione endpointy: Wszystkie /api/* opr√≥cz:
# - POST /auth/login/
# - POST /auth/register/
# - GET /dashboard/projects/public/
# - GET /api/projects/new/json?published=true
```

### CORS Configuration
```python
CORS_ALLOWED_ORIGINS = [
    "http://localhost:3000",           # Development
    "https://universemapmaker.online", # Production
]
CORS_ALLOW_CREDENTIALS = True
```

**Status:** ‚úÖ Poprawnie skonfigurowane

---

## üìû KONTAKT W RAZIE PYTA≈É

- **Backend Bug:** `service.py:4591` - zg≈Ço≈õ do Backend Team
- **Frontend API:** `src/redux/api/` - pytaj Frontend Team
- **QGIS Server:** Sprawd≈∫ konfiguracjƒô w `.env` i `settings.py`

---

**Raport wygenerowany:** 2025-01-13
**Autor analizy:** Claude (Anthropic AI)
**Wersja backendu:** Django REST Framework + QGIS 3.x
**Wersja frontendu:** Next.js 15 + RTK Query

